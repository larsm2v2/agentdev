<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Email Librarian - AI-Powered Email Organization</title>
    <!-- Local Tailwind CSS build instead of CDN -->
    <link rel="stylesheet" href="/static/styles/output.css" />
    <script
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
      defer
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="/static/styles/email_librarian.css" />
    <script src="/static/js/components-loader.js"></script>
    <script src="/static/js/tab-loader-new.js"></script>
    <style>
      /* Critical CSS to prevent layout reflow loops */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
      }

      /* Prevent Alpine.js from causing layout shifts */
      [x-cloak] {
        display: none !important;
      }

      /* Stabilize grid layouts */
      .grid {
        overflow: hidden;
        contain: layout;
      }

      /* Prevent cards from causing reflows */
      .function-card,
      .stats-card {
        will-change: transform;
        contain: layout style;
        backface-visibility: hidden;
        transform: translateZ(0);
      }

      /* Stabilize tab content */
      .tab-content {
        contain: layout style;
        transform: translateZ(0);
      }

      /* Optimize animations */
      .slider::before,
      .progress-bar-fill {
        will-change: transform, width;
        contain: layout;
      }

      /* Main container constraints */
      .max-w-7xl {
        max-width: min(80rem, calc(100vw - 2rem));
        overflow-x: hidden;
      }

      /* Prevent content overflow on smaller screens */
      @media (max-width: 1024px) {
        .lg\\:grid-cols-4 {
          grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
        }
      }

      @media (max-width: 768px) {
        .md\\:grid-cols-2,
        .md\\:grid-cols-4 {
          grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
        }
      }

      /* Stabilize progress bars */
      .progress-bar-fill {
        transition: width 0.3s ease;
        contain: layout style;
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <div
      x-data="enhancedEmailLibrarianApp()"
      x-init="init()"
      x-cloak
      class="min-h-screen"
    >
      <!-- Connection Status Indicator -->
      <div
        class="connection-status"
        :class="connectionStatus"
        x-show="connectionStatus !== 'connected'"
      >
        <i class="fas fa-circle mr-2"></i>
        <span
          x-text="connectionStatus.charAt(0).toUpperCase() + connectionStatus.slice(1)"
        ></span>
      </div>

      <!-- Notification System -->
      <div class="fixed top-4 right-4 z-50 space-y-2" style="max-width: 300px">
        <template x-for="notification in notifications" :key="notification.id">
          <div
            class="notification bg-white rounded-lg shadow-lg p-4 border-l-4"
            :class="`border-${notification.type === 'success' ? 'green' : notification.type === 'error' ? 'red' : 'blue'}-500`"
            x-transition:enter="transform ease-out duration-300 translate-x-full"
            x-transition:enter-start="transform translate-x-full"
            x-transition:enter-end="transform translate-x-0"
            x-transition:leave="transform ease-in duration-200"
            x-transition:leave-start="transform translate-x-0"
            x-transition:leave-end="transform translate-x-full"
          >
            <div class="flex justify-between items-start">
              <div class="flex items-start">
                <i
                  :class="`fas ${notification.type === 'success' ? 'fa-check-circle text-green-500' : 
                                              notification.type === 'error' ? 'fa-exclamation-circle text-red-500' : 
                                              'fa-info-circle text-blue-500'} mr-2 mt-0.5`"
                ></i>
                <div class="ml-2">
                  <p
                    class="text-sm font-medium"
                    x-text="notification.message"
                  ></p>
                  <p class="text-xs text-gray-500">
                    <span
                      x-text="new Date(notification.timestamp).toLocaleTimeString()"
                    ></span>
                  </p>
                </div>
              </div>
              <button
                @click="dismissNotification(notification.id)"
                class="text-gray-400 hover:text-gray-600"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </template>
      </div>

      <!-- Loading Overlay -->
      <div
        x-show="isLoading"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40"
        x-transition
      >
        <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
          <div class="loading-spinner"></div>
          <span class="text-gray-700">Processing...</span>
        </div>
      </div>

      <!-- Main Content Container - This is missing in your original HTML -->
      <div class="container mx-auto max-w-7xl px-4 py-8">
        <!-- Header and Navigation -->
        <header class="mb-8">
          <div class="flex justify-between items-center">
            <div class="flex items-center">
              <i class="fas fa-book-reader text-3xl text-blue-500 mr-3"></i>
              <h1 class="text-3xl font-bold text-gray-800">Email Librarian</h1>
            </div>
            <div>
              <button
                @click="gmailAuthenticated ? null : authenticateGmail()"
                class="px-4 py-2 rounded-md"
                :class="gmailAuthenticated ? 'bg-green-500 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'"
              >
                <i class="fab fa-google mr-2"></i>
                <span
                  x-text="gmailAuthenticated ? 'Gmail Connected' : 'Connect Gmail'"
                ></span>
              </button>
            </div>
          </div>

          <!-- Navigation Tabs -->
          <div class="mt-8 border-b border-gray-200">
            <nav class="flex space-x-8">
              <button
                @click="showTab = 'shelving'"
                class="py-4 px-1 border-b-2 font-medium text-lg"
                :class="showTab === 'shelving' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              >
                <i class="fas fa-inbox mr-2"></i>
                Shelving
              </button>
              <button
                @click="showTab = 'cataloging'"
                class="py-4 px-1 border-b-2 font-medium text-lg"
                :class="showTab === 'cataloging' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              >
                <i class="fas fa-archive mr-2"></i>
                Cataloging
              </button>
              <button
                @click="showTab = 'reclassification'"
                class="py-4 px-1 border-b-2 font-medium text-lg"
                :class="showTab === 'reclassification' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              >
                <i class="fas fa-tags mr-2"></i>
                Reclassification
              </button>
              <button
                @click="showTab = 'workflows'"
                class="py-4 px-1 border-b-2 font-medium text-lg"
                :class="showTab === 'workflows' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
              >
                <i class="fas fa-sitemap mr-2"></i>
                Workflows
              </button>
            </nav>
          </div>
        </header>

        <!-- Tab content will be loaded here -->
      </div>
    </div>

    <!-- Include enhanced Email Librarian Controller -->
    <script src="/static/js/email_librarian.js"></script>

    <!-- Add tab components -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Create tab containers first - this is important
        const container = document.querySelector(".max-w-7xl");

        // Create containers for each tab
        const shelvingTab = document.createElement("div");
        shelvingTab.id = "shelving-tab-container";
        shelvingTab.setAttribute("x-show", "showTab === 'shelving'");
        container.appendChild(shelvingTab);

        const catalogingTab = document.createElement("div");
        catalogingTab.id = "cataloging-tab-container";
        catalogingTab.setAttribute("x-show", "showTab === 'cataloging'");
        container.appendChild(catalogingTab);

        const reclassificationTab = document.createElement("div");
        reclassificationTab.id = "reclassification-tab-container";
        reclassificationTab.setAttribute(
          "x-show",
          "showTab === 'reclassification'"
        );
        container.appendChild(reclassificationTab);

        const workflowsTab = document.createElement("div");
        workflowsTab.id = "workflows-tab-container";
        workflowsTab.setAttribute("x-show", "showTab === 'workflows'");
        container.appendChild(workflowsTab);

        console.log("Tab containers created and ready for component loading");
      });
    </script>
  </body>
</html>
