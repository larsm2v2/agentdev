<!-- Cataloging Tab -->
<div x-data="catalogingController()" x-init="init()" class="space-y-6 p-4">
  <!-- Date Range and Batch Size Controls -->
  <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
      Cataloging Configuration
    </h3>

    <!-- Date Range -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Start Date</label
        >
        <input
          type="date"
          x-model="startDate"
          class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
        />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >End Date</label
        >
        <input
          type="date"
          x-model="endDate"
          class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
        />
      </div>
    </div>

    <!-- Batch Size -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1"
        >Batch Size</label
      >
      <div class="flex items-center space-x-2">
        <input
          type="range"
          x-model.number="batchSize"
          min="5"
          max="100"
          step="5"
          class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
        />
        <span
          class="text-sm font-medium text-gray-600 w-10 text-center"
          x-text="batchSize"
        ></span>
      </div>
    </div>

    <!-- Category Management Strategy -->
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-1"
        >Category Strategy</label
      >
      <select
        x-model="categoryStrategy"
        class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500"
      >
        <option value="auto">
          Automatic (Use existing + create new when needed)
        </option>
        <option value="strict">Strict (Only use existing categories)</option>
        <option value="regenerate">
          Regenerate All (Create new categories for all emails)
        </option>
      </select>
    </div>

    <!-- Toggle Control -->
    <div class="flex justify-between items-center mt-6">
      <span class="text-sm font-medium text-gray-700">Enable Cataloging</span>
      <button
        @click="toggleCataloging()"
        :class="catalogingActive ? 'bg-blue-600' : 'bg-gray-200'"
        class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <span
          :class="catalogingActive ? 'translate-x-6' : 'translate-x-1'"
          class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform"
        ></span>
      </button>
    </div>
  </div>

  <!-- Progress Section -->
  <div
    x-show="catalogingActive || catalogingCompleted"
    class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"
  >
    <h3 class="text-lg font-medium text-gray-900 mb-4">
      <span x-show="catalogingActive">Cataloging Progress</span>
      <span x-show="!catalogingActive && catalogingCompleted"
        >Cataloging Results</span
      >
    </h3>

    <!-- Progress Bar -->
    <div x-show="catalogingActive" class="mb-4">
      <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
        <div
          class="bg-blue-600 h-2.5 rounded-full"
          :style="`width: ${progress * 100}%`"
        ></div>
      </div>
      <div class="flex justify-between text-xs text-gray-500">
        <span
          x-text="`${processedCount} of ${totalCount} emails processed`"
        ></span>
        <span x-text="`${Math.round(progress * 100)}%`"></span>
      </div>
    </div>

    <!-- Results Summary -->
    <div x-show="catalogingCompleted" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-gray-50 p-3 rounded-md">
          <div class="text-xs text-gray-500">Processed</div>
          <div
            class="text-xl font-semibold"
            x-text="results.processed_count || 0"
          ></div>
        </div>
        <div class="bg-gray-50 p-3 rounded-md">
          <div class="text-xs text-gray-500">Categorized</div>
          <div
            class="text-xl font-semibold"
            x-text="results.categorized_count || 0"
          ></div>
        </div>
        <div class="bg-gray-50 p-3 rounded-md">
          <div class="text-xs text-gray-500">New Categories</div>
          <div
            class="text-xl font-semibold"
            x-text="results.categories_created?.length || 0"
          ></div>
        </div>
      </div>

      <!-- Categories Created -->
      <div x-show="results.categories_created?.length > 0" class="mt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">
          New Categories Created:
        </h4>
        <div class="flex flex-wrap gap-2">
          <span
            x-for="category in results.categories_created"
            class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded"
            x-text="category"
          ></span>
        </div>
      </div>

      <!-- Categories Used -->
      <div x-show="results.categories_used?.length > 0" class="mt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">
          Existing Categories Used:
        </h4>
        <div class="flex flex-wrap gap-2">
          <span
            x-for="category in results.categories_used"
            class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded"
            x-text="category"
          ></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Category Management -->
  <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
      Category Management
      <button
        @click="loadCategories()"
        class="ml-2 text-sm text-blue-600 hover:text-blue-800"
      >
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </h3>

    <!-- Categories List -->
    <div class="space-y-2">
      <div
        x-show="categories.length === 0"
        class="text-sm text-gray-500 italic"
      >
        No categories found. Start cataloging to create categories.
      </div>

      <div
        x-show="categories.length > 0"
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"
      >
        <div
          x-for="category in categories"
          class="flex items-center justify-between bg-gray-50 p-2 rounded"
        >
          <div>
            <span x-text="category.name" class="text-sm font-medium"></span>
            <span
              x-text="`(${category.count})`"
              class="text-xs text-gray-500 ml-1"
            ></span>
          </div>
          <button
            @click="editCategory(category)"
            class="text-gray-400 hover:text-gray-600"
          >
            <i class="fas fa-pencil-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function catalogingController() {
    return {
      // Configuration
      startDate: null,
      endDate: null,
      batchSize: 20,
      categoryStrategy: "auto",

      // Status
      catalogingActive: false,
      catalogingCompleted: false,
      progress: 0,
      processedCount: 0,
      totalCount: 0,
      results: {},
      categories: [],

      // Job ID for polling
      activeJobId: null,
      pollingInterval: null,

      init() {
        // Set default date range (last 7 days)
        const today = new Date();
        const lastWeek = new Date(today);
        lastWeek.setDate(lastWeek.getDate() - 7);

        this.endDate = today.toISOString().split("T")[0];
        this.startDate = lastWeek.toISOString().split("T")[0];

        // Load categories
        this.loadCategories();
      },

      async toggleCataloging() {
        if (this.catalogingActive) {
          // Stop polling when turned off
          this.stopCataloging();
        } else {
          // Start cataloging
          this.catalogingActive = true;
          this.catalogingCompleted = false;
          this.progress = 0;
          this.processedCount = 0;
          this.totalCount = 0;
          this.results = {};

          try {
            const response = await fetch("/api/functions/cataloging/start", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                batch_size: this.batchSize,
                date_range: {
                  start: this.startDate ? `${this.startDate}T00:00:00Z` : null,
                  end: this.endDate ? `${this.endDate}T23:59:59Z` : null,
                },
                strategy: this.categoryStrategy,
              }),
            });

            const data = await response.json();

            if (data.status === "success") {
              this.activeJobId = data.job.job_id;
              this.startPolling();
            } else {
              throw new Error(data.message || "Failed to start cataloging");
            }
          } catch (error) {
            console.error("Error starting cataloging:", error);
            this.catalogingActive = false;
            alert(`Failed to start cataloging: ${error.message}`);
          }
        }
      },

      startPolling() {
        // Poll every 2 seconds
        this.pollingInterval = setInterval(() => this.pollProgress(), 2000);
      },

      async pollProgress() {
        try {
          const response = await fetch("/api/functions/cataloging/progress");
          const data = await response.json();

          this.progress = data.progress || 0;
          this.processedCount = data.processed_count || 0;
          this.totalCount = data.total_count || 0;

          // Check if completed
          if (data.status === "completed") {
            this.results = data.results || {};
            this.catalogingCompleted = true;
            this.stopCataloging();
            this.loadCategories(); // Refresh categories
          }

          // Check if failed
          if (data.status === "failed") {
            this.stopCataloging();
            alert("Cataloging job failed. Please check server logs.");
          }

          // If no active job but we're still polling, stop
          if (data.status === "no_active_job") {
            this.stopCataloging();
          }
        } catch (error) {
          console.error("Error polling progress:", error);
        }
      },

      stopCataloging() {
        this.catalogingActive = false;
        if (this.pollingInterval) {
          clearInterval(this.pollingInterval);
          this.pollingInterval = null;
        }
      },

      async loadCategories() {
        try {
          const response = await fetch("/api/functions/cataloging/categories");
          const data = await response.json();
          this.categories = data.categories || [];
        } catch (error) {
          console.error("Error loading categories:", error);
        }
      },

      editCategory(category) {
        // In a real implementation, you'd open a modal for editing
        alert(
          `Edit category functionality will be implemented in a future update.`
        );
      },
    };
  }
</script>
